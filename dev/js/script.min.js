"use strict";

window.onload = function () {
  // DARK THEME START
  addDarkThemeHtml();
  document.querySelector('.themetoggle').addEventListener('click', function (e) {
    e.preventDefault();

    if (localStorage.getItem('theme') === 'dark') {
      localStorage.removeItem('theme');
      addDarkThemeHtml();
    } else {
      localStorage.setItem('theme', 'dark');
      addDarkThemeHtml();
    }
  });

  function addDarkThemeHtml() {
    try {
      if (localStorage.getItem('theme') === 'dark') {
        document.querySelector('html').classList.add('dark');
        document.querySelector('.themetoggle i').classList.remove('icon-moon');
        document.querySelector('.themetoggle i').classList.add('icon-sun');
      } else {
        document.querySelector('html').classList.remove('dark');
        document.querySelector('.themetoggle i').classList.remove('icon-sun');
        document.querySelector('.themetoggle i').classList.add('icon-moon');
      }
    } catch (err) {
      console.log(err);
    }
  } // DARK THEME END
  // MENU OPEN START


  var burger = document.querySelector('.hamburger');
  var menu = document.querySelector('.menu');
  burger.addEventListener('click', menuOpen);

  function menuOpen() {
    menu.classList.toggle('menu-open');
  }

  menu.addEventListener('click', menuClose);

  function menuClose(e) {
    var targetElem = e.target;
    var goalLink = targetElem.classList.contains('menu__link');

    if (goalLink) {
      targetElem.closest('nav.menu').classList.toggle('menu-open');
    }
  }

  document.addEventListener('click', function (e) {
    var targetElem = e.target;
    var goalLink1 = targetElem.classList.contains('hamburger');
    var goalLink2 = targetElem.classList.contains('hamburger__item');

    if (!goalLink1 && !goalLink2 && menu.classList.contains('menu-open')) {
      menu.classList.remove('menu-open');
    }
  }); // MENU OPEN END
  // VALIDATION ORDER SERVICE START

  var formOrder = document.querySelector('#form');
  var inputName = formOrder.elements.input_name;
  var inputLink = formOrder.elements.input_link;
  var inputEmail = formOrder.elements.input_email;
  var btnOrder = formOrder.querySelector('button[type="submit"]');
  var regexName = /^[A-zА-яЁё, \n]+$/;
  var regexSite = /^[-A-zА-яЁё0-9+&@#\/%?=~_|!:,.;]\.*[-A-zА-яЁё0-9+&@#\/%?=~_|!:,.;]*\.[-A-zА-яЁё0-9+&@#\/%=~_|]/;
  var regexMail = /@(?:[A-z0-9](?:[A-z0-9-]*[A-z0-9])?)/;

  function valid(elem, target, reg) {
    var check = target.parentElement.querySelector('.icon-error');
    var succes = target.parentElement.querySelector('.icon-check');

    if (elem.value.match(reg) && elem.value.length > 0) {
      succes.style.visibility = 'visible';
      check.style.visibility = 'hidden';
    } else if (!elem.value.match(reg) && elem.value.length > 0) {
      succes.style.visibility = 'hidden';
      check.style.visibility = 'visible';
    } else {
      succes.style.visibility = 'hidden';
      check.style.visibility = 'hidden';
    }
  }

  function btnDisabled() {
    var iconCheck = formOrder.querySelectorAll('.icon-check');
    var arr = [];

    for (var i = 0; i < iconCheck.length; i++) {
      if (iconCheck[i].style.visibility == 'visible') {
        arr.push('1');
      }
    }

    if (arr.length >= 3) {
      btnOrder.removeAttribute('disabled');
    } else {
      btnOrder.setAttribute('disabled', 'disabled');
    }
  }

  inputName.oninput = function (event) {
    var target = event.target;
    valid(inputName, target, regexName);
    btnDisabled();
  };

  inputLink.oninput = function (event) {
    var target = event.target;
    valid(inputLink, target, regexSite);
    btnDisabled();
  };

  inputEmail.oninput = function (event) {
    var target = event.target;
    valid(inputEmail, target, regexMail);
    btnDisabled();
  }; // VALIDATION ORDER SERVICE END
  // TELEGRAM SEND START


  var yourId = '';
  /* токен бота */

  var token = '';
  var form = document.forms.mainForm;
  form.addEventListener('submit', function (e) {
    e.preventDefault();
    var name = form.input_name.value;
    var link = form.input_link.value;
    var email = form.input_email.value;
    var tarif = form.input_tarif.value;

    function validateEmail(email, link) {
      if (email.indexOf('@') > -1) {
        if (link.indexOf('.') > -1) {
          return true;
        } else {
          return false;
        }
      } else {
        return false;
      }
    }

    if (validateEmail(email, link) === true) {
      var msg = "Имя:%20" + name + "%0A" + "Ссылка на сайт:%20" + link + "%0A" + "Тариф:%20" + tarif + "%0A" + "Почта/телеграм:%20" + email;
      var xhttp = new XMLHttpRequest();
      var url = "https://api.telegram.org/bot" + token + "/sendMessage?chat_id=" + yourId + "&text=";
      xhttp.open('GET', url + msg);
      xhttp.send();
      form.input_name.value = '';
      form.input_link.value = '';
      form.input_email.value = '';
      form.input_tarif.value = '';
      var push = document.querySelector('.push-block');
      var pushClose = document.querySelector('.push__close');
      var body = document.body;
      xhttp.addEventListener('readystatechange', function () {
        if (this.readyState === 4 && this.status === 200) {
          var checks = document.querySelectorAll('.icon-error');
          var success = document.querySelectorAll('.icon-check');
          checks.forEach(function (item) {
            return item.style.visibility = 'hidden';
          });
          success.forEach(function (item) {
            return item.style.visibility = 'hidden';
          });
          disableScroll();
          push.classList.add('push-block-active');
          setTimeout(function () {
            return push.style.opacity = 1;
          }, 500);
          setTimeout(function () {
            push.style.opacity = 0;
            setTimeout(function () {
              push.classList.remove('push-block-active');
              enableScroll();
            }, 500);
          }, 5000);
        }
      });
      pushClose.addEventListener('click', function () {
        push.style.opacity = 0;
        setTimeout(function () {
          push.classList.remove('push-block-active');
          enableScroll();
        }, 500);
      });

      function disableScroll() {
        var pagePosition = window.scrollY;
        body.classList.add('scroll-hidden');
        body.dataset.position = pagePosition;
      }

      function enableScroll() {
        var pagePosition = parseInt(body.dataset.position, 10);
        body.style.top = 'auto';
        body.classList.remove('scroll-hidden');
        window.scroll({
          top: pagePosition,
          left: 0
        });
        body.removeAttribute('data-position');
      }
    }
  }); // TELEGRAM SEND END
  // PRICE OPEN START

  var workProduct = document.querySelectorAll('.workcost__product');
  workProduct.forEach(function (element) {
    element.addEventListener('click', function (e) {
      var target = e.target;
      var workInfo = element.querySelector('.workcost__info');

      if (target.classList.contains('workcost__title')) {
        element.classList.toggle('workcost__product-open');
        workInfo.classList.toggle('workcost__info-open');
      } else if (target.parentElement.classList.contains('workcost__title')) {
        element.classList.toggle('workcost__product-open');
        workInfo.classList.toggle('workcost__info-open');
      } else {
        return false;
      }
    });
  });
  var tarifs = document.querySelectorAll('.input_tarif');
  var workcostBtn = document.querySelectorAll('.workcost__btn');
  workcostBtn.forEach(function (item) {
    item.onclick = function () {
      var form = document.getElementById('form');
      var cost = parseInt(item.innerHTML.match(/\d+/));

      if (cost == 500) {
        tarifs[0].checked = true;
        tarifs[0].setAttribute('checked', 'checked');
        tarifs[1].removeAttribute('checked', 'checked');
        tarifs[2].removeAttribute('checked', 'checked');
      }

      if (cost == 1000) {
        tarifs[1].checked = true;
        tarifs[1].setAttribute('checked', 'checked');
        tarifs[0].removeAttribute('checked', 'checked');
        tarifs[2].removeAttribute('checked', 'checked');
      }

      if (cost == 1500) {
        tarifs[2].checked = true;
        tarifs[2].setAttribute('checked', 'checked');
        tarifs[0].removeAttribute('checked', 'checked');
        tarifs[1].removeAttribute('checked', 'checked');
      }

      form.scrollIntoView(form.clientWidth);
    };
  }); // PRICE OPEN END
  // CAROUSEL WORKS START

  var carouselWork = document.querySelector('.portfolio__carousel');
  var listWork = carouselWork.querySelector('.portfolio__slider');
  var listElemsWork = carouselWork.querySelectorAll('.portfolio__item');
  var btnPrevWork = carouselWork.querySelector('.portfolio__arrow-prev');
  var btnNextWork = carouselWork.querySelector('.portfolio__arrow-next');
  var btnLoadWork = document.querySelector('.portfolio__btn-load');
  var positionWork = 0;
  var widthWork = 347;
  var countWork;

  function setCount() {
    if (window.innerWidth > 1240) {
      return 3;
    } else if (window.innerWidth <= 1240) {
      return 2;
    }
  }

  btnPrevWork.onclick = function () {
    countWork = setCount();
    positionWork += widthWork * countWork;

    if (positionWork == 0) {
      this.setAttribute('disabled', 'disabled');
      btnNextWork.removeAttribute('disabled');
    } else {
      this.removeAttribute('disabled');
      btnNextWork.removeAttribute('disabled');
    }

    positionWork = Math.min(positionWork, 0);
    listWork.style.marginLeft = positionWork + 'px';
  };

  btnNextWork.onclick = function () {
    countWork = setCount();
    positionWork -= widthWork * countWork;
    var disPointWork = listElemsWork.length * widthWork;

    if (Math.abs(positionWork) >= disPointWork) {
      this.setAttribute('disabled', 'disabled');
      btnPrevWork.removeAttribute('disabled');
    } else {
      this.removeAttribute('disabled');
      btnPrevWork.removeAttribute('disabled');
    }

    positionWork = Math.max(positionWork, -widthWork * (listElemsWork.length - countWork));
    listWork.style.marginLeft = positionWork + 'px';
  };

  btnLoadWork.onclick = function () {
    var arrClass = [];
    listElemsWork.forEach(function (item, ind) {
      if (item.classList.contains('portfolio__item-open')) {
        arrClass.push(ind);
      }
    });

    if (arrClass.length < listElemsWork.length) {
      var diffLength = listElemsWork.length - arrClass.length;

      if (diffLength > 3) {
        for (var i = arrClass.length; i < arrClass.length + 3; i++) {
          listElemsWork[i].classList.remove('portfolio__item-close');
          listElemsWork[i].classList.add('portfolio__item-open');
        }
      } else {
        for (var _i = arrClass.length; _i < arrClass.length + diffLength; _i++) {
          listElemsWork[_i].classList.remove('portfolio__item-close');

          listElemsWork[_i].classList.add('portfolio__item-open');
        }
      }
    } else {
      listElemsWork.forEach(function (item, ind) {
        if (ind > 2) {
          item.classList.remove('portfolio__item-open');
          item.classList.add('portfolio__item-close');
        }
      });
      window.open('https://kwork.ru/user/fedor-work', '_blank');
    }
  };

  window.addEventListener('resize', function () {
    listWork.style.marginLeft = "0px";
  }); // CAROUSEL WORKS END
};